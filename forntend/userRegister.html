<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User Registration</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <script defer src="navbar.js"></script>
  <style>
    .form-container {
      max-width: 900px;
      margin: 3rem auto;
    }

    .error {
      color: red;
      font-size: 0.85em;
      display: none;
    }
  </style>
</head>

<body class="bg-light">
  <!-- Navigation -->
  <div id="navbar-container"></div>

  <div class="container form-container">
    <h2 class="text-center fw-bold mb-4">E.D.G.E User Registration</h2>

    <form id="registrationForm" novalidate>
      <!-- Login Credentials -->
      <h5>Account Credentials</h5>
      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="username" class="form-label">Username <span class="text-danger">*</span></label>
          <input type="text" class="form-control" id="username" required />
          <div class="error" id="usernameError">Username is required.</div>
        </div>
        <div class="col-md-6 mb-3">
          <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
          <input type="email" class="form-control" id="email" required />
          <div class="error" id="emailError">Valid email is required.</div>
        </div>
      </div>

      <!-- Personal Info -->
      <h5 class="mt-4">Personal Information</h5>
      <div class="row">
        <div class="col-md-4 mb-3">
          <label for="firstName" class="form-label">First Name <span class="text-danger">*</span></label>
          <input type="text" class="form-control" id="firstName" required />
          <div class="error" id="firstNameError">First name is required.</div>
        </div>
        <div class="col-md-4 mb-3">
          <label for="middleName" class="form-label">Middle Name</label>
          <input type="text" class="form-control" id="middleName" />
        </div>
        <div class="col-md-4 mb-3">
          <label for="lastName" class="form-label">Last Name <span class="text-danger">*</span></label>
          <input type="text" class="form-control" id="lastName" required />
          <div class="error" id="lastNameError">Last name is required.</div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="dob" class="form-label">Date of Birth <span class="text-danger">*</span></label>
          <input type="date" class="form-control" id="dob" />
          <div class="error" id="dobError">Date of birth is required.</div>
        </div>
        <div class="col-md-6 mb-3">
          <label for="gender" class="form-label">Gender <span class="text-danger">*</span></label>
          <select class="form-select" id="gender" required>
            <option value="">Select</option>
            <option value="male">Male</option>
            <option value="female">Female</option>
            <option value="other">Other</option>
          </select>
          <div class="error" id="genderError">Please select a gender.</div>
        </div>
      </div>

      <!-- Address -->
      <h5 class="mt-4">Address</h5>
      <div class="mb-3">
        <label for="street" class="form-label">Street</label>
        <input type="text" class="form-control" id="street" />
      </div>
      <div class="row">
        <div class="col-md-4 mb-3">
          <label for="city" class="form-label">City <span class="text-danger">*</span></label>
          <input type="text" class="form-control" id="city" required />
          <div class="error" id="cityError">City is required.</div>
        </div>
        <div class="col-md-4 mb-3">
          <label for="state" class="form-label">State <span class="text-danger">*</span></label>
          <input type="text" class="form-control" id="state" required />
          <div class="error" id="stateError">State is required.</div>
        </div>
        <div class="col-md-4 mb-3">
          <label for="zip" class="form-label">ZIP Code <span class="text-danger">*</span></label>
          <input type="text" class="form-control" id="zip" required />
          <div class="error" id="zipError">ZIP Code is required.</div>
        </div>
      </div>
      <div class="mb-3">
        <label for="country" class="form-label">Country <span class="text-danger">*</span></label>
        <input type="text" class="form-control" id="country" required />
        <div class="error" id="countryError">Country is required.</div>
      </div>

      <!-- Contact -->
      <div class="mb-3">
        <label for="phoneNumbers" class="form-label">Phone Number <span class="text-danger">*</span></label>
        <input type="number" class="form-control" id="phoneNumbers" required />
        <div class="error" id="phoneError">Phone number is required.</div>
      </div>

      <!-- Emergency -->
      <h5 class="mt-4">Emergency Contact</h5>
      <div class="row">
        <div class="col-md-4 mb-3">
          <label for="emergencyName" class="form-label">Name</label>
          <input type="text" class="form-control" id="emergencyName" />
        </div>
        <div class="col-md-4 mb-3">
          <label for="relationship" class="form-label">Relationship</label>
          <input type="text" class="form-control" id="relationship" />
        </div>
        <div class="col-md-4 mb-3">
          <label for="emergencyPhone" class="form-label">Phone</label>
          <input type="text" class="form-control" id="emergencyPhone" />
        </div>
      </div>

      <!-- Roles -->
      <div class="mb-3">
        <label class="form-label" for="roleUser">Register as:</label><br />
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" id="roleUser" value="user" checked />
          <label class="form-check-label" for="roleUser">User</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" id="roleAdmin" value="admin" />
          <label class="form-check-label" for="roleAdmin">Admin</label>
        </div>
      </div>

      <!-- Submit -->
      <div class="text-center mt-4">
        <button type="submit" class="btn btn-success px-4">Register</button>
      </div>
    </form>
  </div><!-- Footer -->

  <div id="footer-container" class="mt-3"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="footer.js"></script>

  <script>
    document.getElementById("registrationForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      // Validation
      let valid = true;

      const fields = [
        { id: "username", errorId: "usernameError" },
        { id: "email", errorId: "emailError", validate: value => value.includes("@") },
        { id: "firstName", errorId: "firstNameError" },
        { id: "lastName", errorId: "lastNameError" },
        { id: "dob", errorId: "dobError" },
        { id: "gender", errorId: "genderError", validate: value => value !== "" },
        { id: "city", errorId: "cityError" },
        { id: "state", errorId: "stateError" },
        { id: "zip", errorId: "zipError" },
        { id: "country", errorId: "countryError" },
        { id: "phoneNumbers", errorId: "phoneError" }
      ];

      fields.forEach(({ id, errorId, validate }) => {
        const field = document.getElementById(id);
        const value = field.value.trim();
        const isValid = validate ? validate(value) : value !== "";
        document.getElementById(errorId).style.display = isValid ? "none" : "block";
        if (!isValid) valid = false;
      });

      if (!valid) return;

      // Data payload
      const data = {
        username: username.value.trim(),
        email: email.value.toLowerCase().trim(),
        password: null,
        roles: [
          ...(document.getElementById("roleUser").checked ? ["user"] : []),
          ...(document.getElementById("roleAdmin").checked ? ["admin"] : [])
        ],
        personalInfo: {
          fullName: {
            first: document.getElementById("firstName").value,
            middle: document.getElementById("middleName").value,
            last: document.getElementById("lastName").value,
          },
          dob: document.getElementById("dob").value,
          gender: document.getElementById("gender").value,
          phoneNumbers: document.getElementById("phoneNumbers").value
            .split(",")
            .map(n => n.trim()).filter(Boolean),
          address: {
            street: document.getElementById("street").value,
            city: document.getElementById("city").value,
            state: document.getElementById("state").value,
            zip: document.getElementById("zip").value,
            country: document.getElementById("country").value,
          },
          emergencyContact: {
            name: document.getElementById("emergencyName").value,
            relationship: document.getElementById("relationship").value,
            phone: document.getElementById("emergencyPhone").value,
          }
        }
      };

      // Submit
      var token = localStorage.getItem("authToken") || null;
      try {
        const res = await fetch("http://localhost:3000/api/auth/register", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`,
          },

          body: JSON.stringify(data),
        });

        if (res.ok) {
          const blob = await res.blob();
          const url = URL.createObjectURL(blob);

          const link = document.createElement("a");
          link.href = url;
          link.download = username.value.trim() + "_credentials.txt";
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);

          alert("User registered successfully! Credentials downloaded.");
          document.getElementById("registrationForm").reset();
        } else {
          alert(result.message || "Something went wrong.");
        }
      } catch (error) {
        alert("Error submitting form");
        console.error(error);
      }
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>